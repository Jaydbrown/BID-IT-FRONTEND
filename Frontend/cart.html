<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shopping Cart | BID IT</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --accent: #f72585;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #212529;
      --gray-100: #f8f9fa;
      --gray-200: #e9ecef;
      --gray-300: #dee2e6;
      --gray-600: #6c757d;
      --gray-800: #343a40;
      --border-radius: 12px;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: var(--gray-800);
      background-color: var(--gray-100);
    }

    /* NAVBAR */
    .navbar {
      background-color: white;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: var(--shadow-sm);
      padding: 1rem 0;
      height: 80px;
    }

    .navbar-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
      height: 100%;
    }

    .navbar-brand {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      color: var(--primary);
      font-weight: 700;
      text-decoration: none;
    }

    .navbar-links {
      display: flex;
      gap: 2rem;
      align-items: center;
    }

    .navbar-links a {
      color: var(--gray-800);
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
    }

    .navbar-links a:hover {
      color: var(--primary);
    }

    /* MAIN CONTENT */
    .main-content {
      margin-top: 80px;
      min-height: calc(100vh - 80px);
      padding: 3rem 2rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-header h1 {
      font-size: 2.5rem;
      font-family: 'Playfair Display', serif;
      color: var(--dark);
      margin-bottom: 0.5rem;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: var(--gray-600);
    }

    .breadcrumb a {
      color: var(--primary);
      text-decoration: none;
    }

    /* CART LAYOUT */
    .cart-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2rem;
    }

    /* CART ITEMS */
    .cart-items {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      padding: 2rem;
    }

    .cart-items-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--gray-200);
    }

    .cart-items-header h2 {
      font-size: 1.5rem;
      font-family: 'Playfair Display', serif;
    }

    .clear-cart-btn {
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .clear-cart-btn:hover {
      text-decoration: underline;
    }

    .cart-item {
      display: flex;
      gap: 1.5rem;
      padding: 1.5rem 0;
      border-bottom: 1px solid var(--gray-200);
      transition: var(--transition);
    }

    .cart-item:hover {
      background-color: var(--gray-100);
      padding-left: 1rem;
      padding-right: 1rem;
      margin-left: -1rem;
      margin-right: -1rem;
      border-radius: var(--border-radius);
    }

    .cart-item-image {
      width: 120px;
      height: 120px;
      border-radius: var(--border-radius);
      overflow: hidden;
      flex-shrink: 0;
    }

    .cart-item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .cart-item-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .cart-item-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--dark);
    }

    .cart-item-seller {
      font-size: 0.9rem;
      color: var(--gray-600);
      margin-bottom: 0.5rem;
    }

    .cart-item-price {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary);
    }

    .cart-item-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .quantity-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--gray-100);
      padding: 0.5rem;
      border-radius: var(--border-radius);
    }

    .quantity-btn {
      width: 30px;
      height: 30px;
      border: none;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .quantity-btn:hover {
      background: var(--primary);
      color: white;
    }

    .quantity-value {
      min-width: 30px;
      text-align: center;
      font-weight: 600;
    }

    .remove-btn {
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0.5rem;
      transition: var(--transition);
    }

    .remove-btn:hover {
      transform: scale(1.2);
    }

    /* CART SUMMARY */
    .cart-summary {
      position: sticky;
      top: 100px;
      height: fit-content;
    }

    .summary-card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      padding: 2rem;
    }

    .summary-card h3 {
      font-size: 1.3rem;
      font-family: 'Playfair Display', serif;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--gray-200);
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      color: var(--gray-600);
    }

    .summary-row.total {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 2px solid var(--gray-200);
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--dark);
    }

    .summary-row.total .amount {
      color: var(--primary);
      font-size: 1.5rem;
    }

    .checkout-btn {
      width: 100%;
      padding: 1.25rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .checkout-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .checkout-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .continue-shopping {
      width: 100%;
      padding: 1rem;
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
      border-radius: var(--border-radius);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 1rem;
      text-decoration: none;
      display: block;
      text-align: center;
    }

    .continue-shopping:hover {
      background: var(--primary);
      color: white;
    }

    /* EMPTY CART */
    .empty-cart {
      text-align: center;
      padding: 4rem 2rem;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
    }

    .empty-cart i {
      font-size: 5rem;
      color: var(--gray-300);
      margin-bottom: 1.5rem;
    }

    .empty-cart h3 {
      font-size: 1.8rem;
      font-family: 'Playfair Display', serif;
      margin-bottom: 1rem;
    }

    .empty-cart p {
      color: var(--gray-600);
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }

    /* LOADING STATE */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem;
      color: var(--gray-600);
    }

    .spinner {
      border: 4px solid var(--gray-200);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* FOOTER */
    .site-footer {
      background-color: var(--gray-800);
      color: white;
      padding: 3rem 2rem 1rem;
      margin-top: 3rem;
    }

    .footer-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2.5rem;
      max-width: 1400px;
      margin: 0 auto 2rem;
    }

    .footer-brand h3 {
      color: white;
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .footer-brand p {
      color: var(--gray-400);
      line-height: 1.8;
    }

    .footer-links h4 {
      color: white;
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .footer-links a {
      display: block;
      color: var(--gray-400);
      text-decoration: none;
      margin-bottom: 0.75rem;
      transition: var(--transition);
    }

    .footer-links a:hover {
      color: var(--primary);
      padding-left: 0.5rem;
    }

    .footer-bottom {
      text-align: center;
      padding-top: 2rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      color: var(--gray-500);
      max-width: 1400px;
      margin: 0 auto;
    }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .cart-layout {
        grid-template-columns: 1fr;
      }

      .cart-summary {
        position: static;
      }
    }

    @media (max-width: 768px) {
      .navbar-container {
        padding: 0 1rem;
      }

      .main-content {
        padding: 2rem 1rem;
      }

      .cart-items,
      .summary-card {
        padding: 1.5rem;
      }

      .cart-item {
        flex-direction: column;
      }

      .cart-item-image {
        width: 100%;
        height: 200px;
      }
    }

    @media (max-width: 480px) {
      .page-header h1 {
        font-size: 2rem;
      }

      .cart-item-actions {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="index.html" class="navbar-brand">BID IT</a>
      <div class="navbar-links">
        <a href="index.html">Home</a>
        <a href="buyerPage.html">Browse</a>
        <a href="sellerPage.html">Sell</a>
        <a href="cart.html"><i class="fas fa-shopping-cart"></i> Cart</a>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <div class="container">
      <!-- PAGE HEADER -->
      <div class="page-header">
        <div class="breadcrumb">
          <a href="index.html">Home</a>
          <i class="fas fa-chevron-right"></i>
          <span>Shopping Cart</span>
        </div>
        <h1>Shopping Cart</h1>
      </div>

      <!-- CART CONTENT -->
      <div id="cartContent">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading your cart...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-brand">
        <h3>BID IT</h3>
        <p>Nigeria's premier student marketplace. Connecting university students across the nation.</p>
      </div>

      <div class="footer-links">
        <h4>Quick Links</h4>
        <a href="index.html">Home</a>
        <a href="buyerPage.html">Browse Products</a>
        <a href="sellerPage.html">Become a Seller</a>
        <a href="help.html">Help Center</a>
      </div>

      <div class="footer-links">
        <h4>Support</h4>
        <a href="#">FAQ</a>
        <a href="#">Shipping Info</a>
        <a href="#">Returns</a>
        <a href="#">Contact Us</a>
      </div>
    </div>

    <div class="footer-bottom">
      <p>&copy; 2025 BID IT. All rights reserved.</p>
    </div>
  </footer>

  <!-- Toast Container -->
  <div id="toastContainer" style="position: fixed; top: 100px; right: 2rem; z-index: 4000;"></div>

  <!-- Paystack Script -->
  <script src="https://js.paystack.co/v1/inline.js"></script>

  <script>
    // ==========================
    // CONSTANTS
    // ==========================
    const API_BASE_URL = 'https://bid-it-backend.onrender.com/api';
    const PAYSTACK_PUBLIC_KEY = 'pk_test_f50f3f81315685aaee766c97128f172c9abe1adf';

    // ==========================
    // BYPASS PROVIDER.JS
    // ==========================
    const originalXHR = window.XMLHttpRequest;

    function cleanFetch(url, options = {}) {
      return new Promise((resolve, reject) => {
        const xhr = new originalXHR();
        const method = options.method || 'GET';
        
        xhr.open(method, url, true);
        
        if (options.headers) {
          Object.keys(options.headers).forEach(key => {
            xhr.setRequestHeader(key, options.headers[key]);
          });
        }
        
        xhr.onload = () => {
          const response = {
            ok: xhr.status >= 200 && xhr.status < 300,
            status: xhr.status,
            statusText: xhr.statusText,
            json: () => Promise.resolve(JSON.parse(xhr.responseText)),
            text: () => Promise.resolve(xhr.responseText)
          };
          resolve(response);
        };
        
        xhr.onerror = () => reject(new Error('Network error'));
        xhr.ontimeout = () => reject(new Error('Request timeout'));
        
        if (options.body) {
          xhr.send(options.body);
        } else {
          xhr.send();
        }
      });
    }

    // ==========================
    // UTILITY FUNCTIONS
    // ==========================
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.style.cssText = `
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        border-left: 4px solid ${type === 'success' ? '#28a745' : '#dc3545'};
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        animation: slideIn 0.3s ease;
      `;
      
      toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}" 
           style="color: ${type === 'success' ? '#28a745' : '#dc3545'}"></i>
        ${message}
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function getAuthToken() {
      return localStorage.getItem('token');
    }

    function getAuthHeaders() {
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getAuthToken()}`
      };
    }

    function formatCurrency(amount) {
      return `₦${parseFloat(amount || 0).toLocaleString()}`;
    }

    // ==========================
    // CART STATE
    // ==========================
    let cartData = {
      items: [],
      total: 0,
      itemCount: 0
    };

    // ==========================
    // LOAD CART
    // ==========================
    async function loadCart() {
      const token = getAuthToken();
      
      if (!token) {
        showLoginRequired();
        return;
      }

      try {
        const response = await cleanFetch(`${API_BASE_URL}/cart`, {
          headers: getAuthHeaders()
        });

        if (!response.ok) {
          throw new Error('Failed to load cart');
        }

        const data = await response.json();
        cartData = {
          items: data.cartItems || [],
          total: data.total || 0,
          itemCount: data.itemCount || 0
        };

        renderCart();
      } catch (error) {
        console.error('Error loading cart:', error);
        showError('Failed to load cart. Please try again.');
      }
    }

    // ==========================
    // RENDER CART
    // ==========================
    function renderCart() {
      const cartContent = document.getElementById('cartContent');

      if (cartData.items.length === 0) {
        cartContent.innerHTML = `
          <div class="empty-cart">
            <i class="fas fa-shopping-cart"></i>
            <h3>Your cart is empty</h3>
            <p>Add some items to get started!</p>
            <a href="buyerPage.html" class="checkout-btn" style="max-width: 300px; margin: 0 auto;">
              <i class="fas fa-shopping-bag"></i> Browse Products
            </a>
          </div>
        `;
        return;
      }

      cartContent.innerHTML = `
        <div class="cart-layout">
          <!-- Cart Items -->
          <div class="cart-items">
            <div class="cart-items-header">
              <h2>Cart Items (${cartData.itemCount})</h2>
              <button class="clear-cart-btn" onclick="clearCart()">
                <i class="fas fa-trash"></i> Clear Cart
              </button>
            </div>
            <div id="cartItemsList"></div>
          </div>

          <!-- Cart Summary -->
          <div class="cart-summary">
            <div class="summary-card">
              <h3>Order Summary</h3>
              <div class="summary-row">
                <span>Subtotal (${cartData.itemCount} items)</span>
                <span class="amount">${formatCurrency(cartData.total)}</span>
              </div>
              <div class="summary-row">
                <span>Shipping</span>
                <span class="amount">Free</span>
              </div>
              <div class="summary-row total">
                <span>Total</span>
                <span class="amount">${formatCurrency(cartData.total)}</span>
              </div>
              <button class="checkout-btn" onclick="proceedToCheckout()">
                <i class="fas fa-lock"></i> Proceed to Checkout
              </button>
              <a href="buyerPage.html" class="continue-shopping">
                <i class="fas fa-arrow-left"></i> Continue Shopping
              </a>
            </div>
          </div>
        </div>
      `;

      renderCartItems();
    }

    function renderCartItems() {
      const cartItemsList = document.getElementById('cartItemsList');
      if (!cartItemsList) return;

      cartItemsList.innerHTML = cartData.items.map(item => {
        const imageUrl = item.image_url 
          ? `https://bid-it-backend.onrender.com${item.image_url}` 
          : 'https://via.placeholder.com/120x120?text=Product';

        return `
          <div class="cart-item">
            <div class="cart-item-image">
              <img src="${imageUrl}" alt="${item.title}" 
                   onerror="this.src='https://via.placeholder.com/120x120?text=No+Image'">
            </div>
            <div class="cart-item-details">
              <div>
                <div class="cart-item-title">${item.title}</div>
                <div class="cart-item-seller">
                  <i class="fas fa-user"></i> ${item.seller_name || 'Seller'}
                </div>
                <div class="cart-item-price">${formatCurrency(item.price)}</div>
              </div>
              <div class="cart-item-actions">
                <div class="quantity-control">
                  <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.quantity - 1})">
                    <i class="fas fa-minus"></i>
                  </button>
                  <span class="quantity-value">${item.quantity}</span>
                  <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.quantity + 1})">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                <button class="remove-btn" onclick="removeFromCart(${item.id})" title="Remove item">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ==========================
    // CART ACTIONS
    // ==========================
    async function updateQuantity(itemId, newQuantity) {
      if (newQuantity < 1) {
        removeFromCart(itemId);
        return;
      }

      try {
        const response = await cleanFetch(`${API_BASE_URL}/cart/${itemId}`, {
          method: 'PUT',
          headers: getAuthHeaders(),
          body: JSON.stringify({ quantity: newQuantity })
        });

        if (!response.ok) {
          throw new Error('Failed to update quantity');
        }

        showToast('Quantity updated', 'success');
        loadCart();
      } catch (error) {
        console.error('Error updating quantity:', error);
        showToast('Failed to update quantity', 'error');
      }
    }

    async function removeFromCart(itemId) {
      if (!confirm('Remove this item from cart?')) return;

      try {
        const response = await cleanFetch(`${API_BASE_URL}/cart/${itemId}`, {
          method: 'PUT',
          headers: getAuthHeaders(),
          body: JSON.stringify({ quantity: 0 })
        });

        if (!response.ok) {
          throw new Error('Failed to remove item');
        }

        showToast('Item removed from cart', 'success');
        loadCart();
      } catch (error) {
        console.error('Error removing item:', error);
        showToast('Failed to remove item', 'error');
      }
    }

    async function clearCart() {
      if (!confirm('Clear all items from cart?')) return;

      try {
        const response = await cleanFetch(`${API_BASE_URL}/cart`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        if (!response.ok) {
          throw new Error('Failed to clear cart');
        }

        showToast('Cart cleared', 'success');
        loadCart();
      } catch (error) {
        console.error('Error clearing cart:', error);
        showToast('Failed to clear cart', 'error');
      }
    }

    // ==========================
    // CHECKOUT
    // ==========================
    function proceedToCheckout() {
      if (cartData.items.length === 0) {
        showToast('Your cart is empty', 'error');
        return;
      }

      const token = getAuthToken();
      if (!token) {
        showToast('Please login to checkout', 'error');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1500);
        return;
      }

      // Get user email
      let userEmail = 'user@example.com';
      try {
        const tokenPayload = JSON.parse(atob(token.split('.')[1]));
        userEmail = tokenPayload.email || userEmail;
      } catch (e) {
        console.log('Could not extract email');
      }

      // Launch Paystack payment
      const handler = PaystackPop.setup({
        key: PAYSTACK_PUBLIC_KEY,
        email: userEmail,
        amount: cartData.total * 100, // Convert to kobo
        currency: "NGN",
        ref: `CART-${Date.now()}`,
        metadata: {
          custom_fields: [
            { display_name: "Cart Items", variable_name: "items", value: cartData.itemCount },
            { display_name: "Type", variable_name: "type", value: "Cart Purchase" }
          ],
        },
        callback: function (response) {
          handlePaymentSuccess(response);
        },
        onClose: function () {
          showToast('Payment cancelled', 'error');
        }
      });

      handler.openIframe();
    }

    async function handlePaymentSuccess(response) {
      try {
        showToast('Processing payment...', 'success');

        // Here you would typically confirm the payment with your backend
        // For now, we'll just clear the cart
        await cleanFetch(`${API_BASE_URL}/cart`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        showToast('✅ Payment successful! Thank you for your purchase.', 'success');
        
        setTimeout(() => {
          window.location.href = 'buyerPage.html';
        }, 2000);
      } catch (error) {
        console.error('Error processing payment:', error);
        showToast('Payment succeeded but order confirmation failed. Please contact support.', 'error');
      }
    }

    // ==========================
    // ERROR STATES
    // ==========================
    function showLoginRequired() {
      const cartContent = document.getElementByI
